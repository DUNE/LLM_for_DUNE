<div id="dune-gpt-app">

  <style>
    * {
      box-sizing: border-box;
    }
    
    #dune-gpt-app {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 0 40px 0;
      min-height: 100vh;
    }

    .header-section {
      max-width: 800px;
      margin: 0 0 20px 0;
      padding: 0 15px;
    }
    
    .header-section h2 {
      margin: 0 0 10px 0;
    }

    .header-section p {
      margin: 0;
    }
    
    form.dune-gpt-form {
      margin-bottom: 30px;
      max-width: 800px;
      padding: 0 15px;
      width: 100%;
    }
    
    form.dune-gpt-form textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      resize: none;
      overflow: hidden;
      min-height: 50px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    form.dune-gpt-form button {
      padding: 8px 16px;
      font-size: 16px;
      margin-top: 10px;
    }
    
    /* Sources row - horizontal cards */
    .sources-row {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      max-width: 800px;
      padding: 0 15px;
      width: 100%;
      visibility: hidden;
    }
    
    .sources-row.visible {
      visibility: visible;
    }
    
    .source-card {
      flex: 1;
      min-width: 0;
      background: #f8f9fa;
      border: 1px solid #e8eaed;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: block;
      color: inherit;
    }
    
    .source-card:hover {
      background: #e8f0fe;
      border-color: #1a73e8;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .source-thumbnail {
      width: 100%;
      height: 120px;
      background: #e8eaed;
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    
    .source-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .source-thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 36px;
      font-weight: bold;
    }
    
    .source-domain {
      font-size: 12px;
      color: #5f6368;
      text-align: center;
      word-break: break-word;
    }
    
    /* Answer section */
    #dune-gpt-answer {
      max-width: 800px;
      margin: 0;
      padding: 20px 15px;
      background: #ffffff;
      border-radius: 8px;
      width: 100%;
      min-height: 100px;
    }
    
    /* Spinner */
    .spinner-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 15px;
    }
    
    .spinner-icon {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: dune-gpt-spin 1s linear infinite;
    }
    
    .spinner-text {
      font-size: 14px;
      color: #5f6368;
    }
    
    #dune-gpt-logo {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 200px;
      height: auto;
      z-index: 9999;
      max-width: calc(100vw - 40px);
    }
    
    @keyframes dune-gpt-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Tablet and smaller */
    @media (max-width: 768px) {
      #dune-gpt-app {
        padding: 0 0 20px 0;
      }
      
      .header-section {
        padding: 0 10px;
      }
      
      form.dune-gpt-form {
        padding: 0 10px;
      }
      
      .sources-row {
        flex-direction: column;
        padding: 0 10px;
      }
      
      .source-card {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      
      .source-thumbnail {
        width: 100px;
        height: 80px;
        flex-shrink: 0;
        margin-bottom: 0;
      }
      
      .source-info {
        flex: 1;
        min-width: 0;
      }
      
      .source-domain {
        text-align: left;
      }
      
      #dune-gpt-answer {
        padding: 15px 10px;
      }
      
      #dune-gpt-logo {
        width: 120px;
        top: 10px;
        right: 10px;
      }
    }
    
    /* Mobile phones */
    @media (max-width: 480px) {
      .header-section h2 {
        font-size: 1.5rem;
      }
      
      form.dune-gpt-form textarea {
        font-size: 14px;
      }
      
      form.dune-gpt-form button {
        font-size: 14px;
        padding: 6px 12px;
      }
      
      .source-thumbnail {
        width: 80px;
        height: 60px;
      }
      
      .source-thumbnail-placeholder {
        font-size: 24px;
      }
      
      .source-domain {
        font-size: 11px;
      }
      
      #dune-gpt-logo {
        width: 100px;
      }
    }
  </style>

  <div class="header-section">
    <!-- We use h2 so we don't duplicate the big page title WordPress already shows -->
    <!--<h2>DUNE-GPT</h2>-->
    <p>Ask a question about internal DUNE documentation.</p>
  </div>

  <!-- Search Form -->
  <form class="dune-gpt-form">
    <textarea id="dune-gpt-input" placeholder="Ask a question:"></textarea>
    <button type="submit" id="dune-gpt-submit">Send</button>
  </form>

  <!-- Sources Row (3 horizontal cards) -->
  <div class="sources-row" id="dune-gpt-sources-row">
    <!-- Sources will be added here -->
  </div>

  <!-- Answer Section -->
  <div id="dune-gpt-answer">
    <!-- Answer will be streamed here -->
  </div>

  <!-- Optional: show the raw stream for debugging -->
  <pre id="dune-gpt-debug" style="display:none;"></pre>

  <!-- If you want a logo here, upload the image in WordPress Media
       and replace SRC below with that URL. -->
  <!--
  <img src="FULL_URL_TO_DUNE_LOGO" 
       alt="DUNE Logo" 
       id="dune-gpt-logo">
  -->

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    (function() {
      const answerEl = document.getElementById('dune-gpt-answer');
      const submitBtn = document.getElementById('dune-gpt-submit');
      const inputEl = document.getElementById('dune-gpt-input');
      const sourcesRow = document.getElementById('dune-gpt-sources-row');
      const debugEl = document.getElementById('dune-gpt-debug');

      // Auto-resize textarea
      inputEl.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });

      submitBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        const question = inputEl.value.trim();
        if (!question) return;

        // Initial spinner
        answerEl.innerHTML = `
          <div class="spinner-container">
            <div class="spinner-icon"></div>
            <div class="spinner-text">Searching documents...</div>
          </div>
        `;

        sourcesRow.innerHTML = '';
        sourcesRow.classList.remove('visible');
        debugEl.textContent = '';

        const formData = new FormData();
        formData.append('question', question);

        // IMPORTANT: adjust this path to match your backend route
        // after proxying, this should usually be /dune-gpt/ui or /dune-gpt/api/ui
        const response = await fetch("/dune-gpt/ui", {
          method: "POST",
          body: formData
        });

        const reader = response.body.getReader();
        let output = "";
        let isStreaming = false;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = new TextDecoder().decode(value || new Uint8Array());

          debugEl.textContent += chunk;

          if (chunk.includes('STATUS:SEARCHING')) {
            answerEl.innerHTML = `
              <div class="spinner-container">
                <div class="spinner-icon"></div>
                <div class="spinner-text">Searching documents...</div>
              </div>
            `;
            continue;
          }

          if (chunk.includes('STATUS:PROCESSING')) {
            answerEl.innerHTML = `
              <div class="spinner-container">
                <div class="spinner-icon"></div>
                <div class="spinner-text">Processing response...</div>
              </div>
            `;
            continue;
          }

          if (!isStreaming && !chunk.startsWith('STATUS:')) {
            isStreaming = true;
          }

          output += chunk;

          // If backend appends "SOURCES: [{...}]" at the end:
          if (output.includes('SOURCES: ')) {
            const parts = output.split('SOURCES: ');
            const answerText = parts[0];
            const sourcesJson = parts[1];

            answerEl.innerHTML = marked.parse(answerText);

            try {
              const sources = JSON.parse(sourcesJson);
              sources.forEach(source => addSource(source.url));
              sourcesRow.classList.add('visible');
            } catch (e) {
              console.error('Error parsing sources:', e);
            }
            break;
          } else {
            answerEl.innerHTML = marked.parse(output);
          }
        }
      });

      function addSource(url, thumbnailUrl = null) {
        try {
          const domain = new URL(url).hostname.replace('www.', '');
          const sourceCard = document.createElement('a');
          sourceCard.className = 'source-card';
          sourceCard.href = url;
          sourceCard.target = '_blank';

          sourceCard.innerHTML = `
            <div class="source-thumbnail">
              ${
                thumbnailUrl
                  ? `<img src="${thumbnailUrl}" alt="">`
                  : `<div class="source-thumbnail-placeholder">${domain.charAt(0).toUpperCase()}</div>`
              }
            </div>
            <div class="source-info">
              <div class="source-domain">${domain}</div>
            </div>
          `;

          sourcesRow.appendChild(sourceCard);
        } catch (e) {
          console.error('Error adding source:', e);
        }
      }
    })();
  </script>
</div>
